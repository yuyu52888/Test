<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥æ–‡å–®å­—å­¸ç¿’</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
            color: #333;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            overflow: hidden;
            min-height: calc(100vh - 30px);
            display: flex;
            flex-direction: column;
        }
        
        .screen {
            padding: 25px 20px;
            display: none;
            flex-direction: column;
            height: 100%;
            flex: 1;
        }
        
        .active {
            display: flex;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 25px;
            color: #2d3748;
            font-size: 1.4rem;
            font-weight: 600;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 16px 20px;
            border-radius: 12px;
            font-size: 16px;
            margin: 8px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            text-decoration: none;
            font-weight: 500;
            width: 100%;
        }
        
        .btn:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #f7fafc;
            color: #4a5568;
            border: 2px solid #e2e8f0;
        }
        
        .btn-secondary:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }
        
        .btn-danger {
            background: #e53e3e;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c53030;
        }
        
        .btn-success {
            background: #38a169;
            color: white;
        }
        
        .btn-success:hover {
            background: #2f855a;
        }
        
        .setting-group {
            margin: 12px 0;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #4a5568;
            font-size: 14px;
        }
        
        select, input {
            width: 100%;
            padding: 14px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            background: white;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .quiz-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .question {
            font-size: 1.8rem;
            text-align: center;
            margin: 30px 0;
            min-height: 50px;
            color: #2d3748;
            line-height: 1.4;
            padding: 0 10px;
        }
        
        .options {
            display: grid;
            gap: 12px;
            margin: 20px 0;
        }
        
        .option-btn {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            padding: 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            text-align: left;
        }
        
        .option-btn:hover {
            border-color: #667eea;
            background: #edf2f7;
        }
        
        .answer {
            background: #f0fff4;
            border: 2px solid #9ae6b4;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            display: none;
            line-height: 1.5;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .controls .btn {
            flex: 1;
            margin: 0;
        }
        
        .nav-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .nav-controls .btn {
            flex: 1;
            margin: 0;
            padding: 12px;
            font-size: 14px;
        }
        
        .progress {
            text-align: center;
            color: #718096;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .hidden {
            display: none;
        }
        
        .speak-btn {
            background: none;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            color: #667eea;
            margin-left: 8px;
            padding: 5px;
        }
        
        .favorite-btn {
            background: none;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            color: #718096;
            margin-left: 8px;
            padding: 5px;
            transition: color 0.3s;
        }
        
        .favorite-btn.active {
            color: #e53e3e;
        }
        
        .correct {
            background: #9ae6b4 !important;
            border-color: #48bb78 !important;
        }
        
        .incorrect {
            background: #fed7d7 !important;
            border-color: #f56565 !important;
        }
        
        .stats {
            background: #f7fafc;
            padding: 15px;
            border-radius: 12px;
            margin: 10px 0;
            font-size: 14px;
        }
        
        .env-badge {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #e53e3e;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            z-index: 1000;
        }
        
        .favorite-star {
            color: #e53e3e;
            margin-left: 5px;
        }
        
        .category-badge {
            display: inline-block;
            background: #edf2f7;
            color: #4a5568;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            margin-left: 8px;
        }
        
        /* æ‰‹æ©Ÿé©é… */
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .container {
                min-height: calc(100vh - 20px);
                border-radius: 16px;
            }
            
            .screen {
                padding: 20px 15px;
            }
            
            h1 {
                font-size: 1.3rem;
                margin-bottom: 20px;
            }
            
            .question {
                font-size: 1.6rem;
                margin: 25px 0;
            }
            
            .btn {
                padding: 14px 16px;
                font-size: 15px;
            }
        }
        
        /* å°æ‰‹æ©Ÿé©é… */
        @media (max-width: 360px) {
            .question {
                font-size: 1.4rem;
            }
            
            .btn {
                padding: 12px 14px;
                font-size: 14px;
            }
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #718096;
        }
    </style>
</head>
<body>
    <!-- ç’°å¢ƒæ¨™ç¤º -->
    <div id="envBadge" class="env-badge" style="display: none;">æœ¬åœ°æ¨¡å¼</div>
    
    <div class="container">
        <!-- ä¸»é¸å–® -->
        <div id="mainMenu" class="screen active">
            <h1>æ—¥æ–‡å–®å­—å­¸ç¿’</h1>
            <div class="loading" id="loadingText">è¼‰å…¥ä¸­...</div>
            <div id="mainMenuButtons" style="display: none;">
                <button class="btn" data-action="quizSetup">ğŸ“ æ¸¬é©—æ¨¡å¼</button>
                <button class="btn" data-action="studySetup">ğŸ“š èƒŒèª¦æ¨¡å¼</button>
                <button class="btn btn-secondary" data-action="favoriteScreen">â­ æ”¶è—å–®å­—</button>
                <button class="btn btn-secondary" data-action="progressScreen">ğŸ“Š å­¸ç¿’é€²åº¦</button>
            </div>
        </div>
        
        <!-- æ¸¬é©—è¨­å®š -->
        <div id="quizSetup" class="screen">
            <h1>æ¸¬é©—è¨­å®š</h1>
            <div class="setting-group">
                <label>æ¸¬é©—é¡å‹</label>
                <select id="quizType">
                    <option value="mixed">ğŸ¯ ç¶œåˆæ¨¡å¼</option>
    <option value="nouns">ğŸ“– åè©</option>  <!-- æ”¹ç‚º nouns -->
    <option value="i_adjective">ğŸ”µ ã„å½¢å®¹è©</option>
    <option value="na_adjective">ğŸŸ¢ ãªå½¢å®¹è©</option>
    <option value="verb">ğŸƒ å‹•è©</option>    <!-- æ”¹ç‚º verb -->
    <option value="adverb">âš¡ å‰¯è©</option>   <!-- æ”¹ç‚º adverb -->
    <option value="onomatopoeia">ğŸ”Š ç–Šè©</option>
    <option value="keigo">ğŸ™ æ•¬èª</option>
    <option value="grammar">ğŸ“ æ–‡æ³•</option>
    <option value="custom">ğŸ›ï¸ è‡ªå®šç¾©IDç¯„åœ</option>
    <option value="favorite">â­ æ”¶è—å–®å­—</option>
                </select>
            </div>
            <div class="setting-group" id="customRangeGroup" style="display:none">
                <label>IDç¯„åœ (ä¾‹: N001-N050)</label>
                <input type="text" id="customRange" placeholder="N001-N050">
            </div>
            <div class="setting-group">
                <label>é¡Œæ•¸</label>
                <select id="questionCount">
                    <option value="5">5é¡Œ</option>
                    <option value="10" selected>10é¡Œ</option>
                    <option value="15">15é¡Œ</option>
                    <option value="20">20é¡Œ</option>
                    <option value="30">30é¡Œ</option>
                    <option value="50">50é¡Œ</option>
                </select>
            </div>
            <button class="btn btn-success" data-action="startQuiz">é–‹å§‹æ¸¬é©—</button>
            <button class="btn btn-secondary" data-action="mainMenu">è¿”å›ä¸»é¸å–®</button>
        </div>
        
        <!-- èƒŒèª¦è¨­å®š -->
        <div id="studySetup" class="screen">
            <h1>èƒŒèª¦è¨­å®š</h1>
            <div class="setting-group">
                <label>å­¸ç¿’é¡å‹</label>
                <select id="studyType">
    <option value="mixed">ğŸ¯ ç¶œåˆæ¨¡å¼</option>
    <option value="nouns">ğŸ“– åè©</option>  <!-- æ”¹ç‚º nouns -->
    <option value="i_adjective">ğŸ”µ ã„å½¢å®¹è©</option>
    <option value="na_adjective">ğŸŸ¢ ãªå½¢å®¹è©</option>
    <option value="verb">ğŸƒ å‹•è©</option>    <!-- æ”¹ç‚º verb -->
    <option value="adverb">âš¡ å‰¯è©</option>   <!-- æ”¹ç‚º adverb -->
    <option value="onomatopoeia">ğŸ”Š ç–Šè©</option>
    <option value="keigo">ğŸ™ æ•¬èª</option>
    <option value="grammar">ğŸ“ æ–‡æ³•</option>
    <option value="custom">ğŸ›ï¸ è‡ªå®šç¾©IDç¯„åœ</option>
    <option value="favorite">â­ æ”¶è—å–®å­—</option>
                </select>
            </div>
            <div class="setting-group" id="studyCustomRangeGroup" style="display:none">
                <label>IDç¯„åœ (ä¾‹: N001-N050)</label>
                <input type="text" id="studyCustomRange" placeholder="N001-N050">
            </div>
            <button class="btn btn-success" data-action="startStudy">é–‹å§‹èƒŒèª¦</button>
            <button class="btn btn-secondary" data-action="mainMenu">è¿”å›ä¸»é¸å–®</button>
        </div>
        
        <!-- æ¸¬é©—ç•«é¢ -->
        <div id="quizScreen" class="screen">
            <div class="nav-controls">
                <button class="btn btn-secondary" data-action="mainMenu">ğŸ  å›é¦–é </button>
                <button class="btn btn-danger" data-action="endQuizEarly">â¹ï¸ æå‰çµæŸ</button>
            </div>
            <div class="progress" id="progressText">1/10</div>
            <h1>æ¸¬é©—ä¸­ <span id="quizCategory" class="category-badge"></span></h1>
            <div class="quiz-area">
                <div class="question" id="currentQuestion">
                    <span id="questionText"></span>
                    <button class="speak-btn" data-action="speakCurrentWord">ğŸ”Š</button>
                    <button class="favorite-btn" id="quizFavoriteBtn" data-action="toggleFavorite">â˜†</button>
                </div>
                <div class="options" id="optionsContainer"></div>
                <div class="answer" id="answerDisplay"></div>
                <div class="controls">
                    <button class="btn" id="showAnswerBtn" data-action="showAnswer">é¡¯ç¤ºè§£ç­”</button>
                    <button class="btn btn-secondary" id="nextBtn" data-action="nextQuestion" style="display:none">ä¸‹ä¸€é¡Œ</button>
                </div>
            </div>
        </div>
        
        <!-- èƒŒèª¦ç•«é¢ -->
        <div id="studyScreen" class="screen">
            <div class="nav-controls">
                <button class="btn btn-secondary" data-action="mainMenu">ğŸ  å›é¦–é </button>
                <button class="btn btn-danger" data-action="endStudyEarly">â¹ï¸ æå‰çµæŸ</button>
            </div>
            <div class="progress" id="studyProgressText">1/10</div>
            <h1>èƒŒèª¦ä¸­ <span id="studyCategory" class="category-badge"></span></h1>
            <div class="quiz-area">
                <div class="question" id="studyQuestion">
                    <span id="studyQuestionText"></span>
                    <button class="speak-btn" data-action="speakCurrentStudyWord">ğŸ”Š</button>
                    <button class="favorite-btn" id="studyFavoriteBtn" data-action="toggleStudyFavorite">â˜†</button>
                </div>
                <div class="answer" id="studyAnswerDisplay"></div>
                <div class="controls">
                    <button class="btn" data-action="showStudyAnswer">é¡¯ç¤ºè§£ç­”</button>
                    <button class="btn btn-secondary" data-action="nextStudyWord">ä¸‹ä¸€å€‹</button>
                </div>
            </div>
        </div>
        
        <!-- æ”¶è—å–®å­—ç•«é¢ -->
        <div id="favoriteScreen" class="screen">
            <h1>æ”¶è—å–®å­—</h1>
            <div id="favoriteList"></div>
            <div class="controls">
                <button class="btn" data-action="startQuizFromFavorites">æ¸¬é©—æ”¶è—å–®å­—</button>
                <button class="btn" data-action="startStudyFromFavorites">èƒŒèª¦æ”¶è—å–®å­—</button>
                <button class="btn btn-secondary" data-action="mainMenu">è¿”å›ä¸»é¸å–®</button>
            </div>
        </div>
        
        <!-- é€²åº¦ç•«é¢ -->
        <div id="progressScreen" class="screen">
            <h1>å­¸ç¿’é€²åº¦</h1>
            <div id="progressStats"></div>
            <button class="btn btn-secondary" data-action="mainMenu">è¿”å›ä¸»é¸å–®</button>
        </div>
    </div>

    <script>
        // ä½¿ç”¨å‘½åç©ºé–“é¿å…è®Šæ•¸è¡çª
        const app = {
            // å…¨åŸŸè®Šæ•¸
            currentVocab: [],
            currentQuestionIndex: 0,
            score: 0,
            quizMode: true,
            studyWords: [],
            currentStudyIndex: 0,
            isLocal: window.location.protocol === 'file:',
            vocabularyData: {},
            currentQuizType: '',

            // åˆå§‹åŒ–
            init: function() {
                console.log('ğŸš€ åˆå§‹åŒ–æ—¥æ–‡å–®å­—å­¸ç¿’ç³»çµ±...');
                
                // é¡¯ç¤ºç’°å¢ƒæ¨™ç¤º
                if (this.isLocal) {
                    document.getElementById('envBadge').style.display = 'block';
                }
                
                // è¨­å®šäº‹ä»¶ç›£è½å™¨
                this.setupEventListeners();
                
                // è¼‰å…¥å–®å­—è³‡æ–™åº«
                this.loadVocabularyData();
                
                // è¼‰å…¥å­¸ç¿’é€²åº¦å’Œæ”¶è—
                this.loadProgress();
                this.loadFavorites();
            },

            // è¨­å®šäº‹ä»¶ç›£è½å™¨
            setupEventListeners: function() {
                // ç‚ºæ‰€æœ‰æŒ‰éˆ•æ·»åŠ äº‹ä»¶ç›£è½
                document.addEventListener('click', (e) => {
                    if (e.target.matches('[data-action]')) {
                        const action = e.target.getAttribute('data-action');
                        this.handleAction(action);
                    }
                });

                // è¡¨å–®å…ƒç´ äº‹ä»¶ç›£è½
                document.getElementById('quizType').addEventListener('change', () => this.toggleCustomRange());
                document.getElementById('studyType').addEventListener('change', () => this.toggleStudyCustomRange());
            },

            // è™•ç†æŒ‰éˆ•å‹•ä½œ
            handleAction: function(action) {
                console.log('åŸ·è¡Œå‹•ä½œ:', action);
                
                switch(action) {
                    // ç•«é¢åˆ‡æ›
                    case 'mainMenu': this.showScreen('mainMenu'); break;
                    case 'quizSetup': this.showScreen('quizSetup'); break;
                    case 'studySetup': this.showScreen('studySetup'); break;
                    case 'favoriteScreen': this.showScreen('favoriteScreen'); break;
                    case 'progressScreen': this.showScreen('progressScreen'); break;
                    
                    // æ¸¬é©—åŠŸèƒ½
                    case 'startQuiz': this.startQuiz(); break;
                    case 'startStudy': this.startStudy(); break;
                    case 'startQuizFromFavorites': this.startQuizFromFavorites(); break;
                    case 'startStudyFromFavorites': this.startStudyFromFavorites(); break;
                    
                    // æ¸¬é©—æ§åˆ¶
                    case 'showAnswer': this.showAnswer(); break;
                    case 'nextQuestion': this.nextQuestion(); break;
                    case 'endQuizEarly': this.endQuizEarly(); break;
                    
                    // èƒŒèª¦æ§åˆ¶
                    case 'showStudyAnswer': this.showStudyAnswer(); break;
                    case 'nextStudyWord': this.nextStudyWord(); break;
                    case 'endStudyEarly': this.endStudyEarly(); break;
                    
                    // æ”¶è—åŠŸèƒ½
                    case 'toggleFavorite': this.toggleFavorite(); break;
                    case 'toggleStudyFavorite': this.toggleStudyFavorite(); break;
                    
                    // èªéŸ³åŠŸèƒ½
                    case 'speakCurrentWord': this.speakCurrentWord(); break;
                    case 'speakCurrentStudyWord': this.speakCurrentStudyWord(); break;
                }
            },

            // è¼‰å…¥æ”¶è—è³‡æ–™
            loadFavorites: function() {
                if (!localStorage.getItem('vocabFavorites')) {
                    localStorage.setItem('vocabFavorites', '[]');
                }
            },

            // è¼‰å…¥å–®å­—è³‡æ–™åº«
            loadVocabularyData: function() {
                const files = [
                    { name: 'nouns', url: 'data/nouns.js' },
                    { name: 'i_adjectives', url: 'data/i_adjectives.js' },
                    { name: 'na_adjectives', url: 'data/na_adjectives.js' },
                    { name: 'verbs', url: 'data/verbs.js' },
                    { name: 'adverbs', url: 'data/adverbs.js' },
                    { name: 'onomatopoeia', url: 'data/onomatopoeia.js' },
                    { name: 'keigo', url: 'data/keigo.js' },
                    { name: 'grammar', url: 'data/grammar.js' }
                ];

                let loadedCount = 0;
                const totalFiles = files.length;
                
                files.forEach(file => {
                    const script = document.createElement('script');
                    script.src = file.url;
                    script.onload = () => {
                        console.log(`âœ… å·²è¼‰å…¥ ${file.name} è³‡æ–™`);
                        loadedCount++;
                        this.assignVocabularyData(file.name);
                        
                        if (loadedCount === totalFiles) {
                            console.log('ğŸ‰ æ‰€æœ‰å–®å­—è³‡æ–™è¼‰å…¥å®Œæˆ');
                            this.ensureVocabularyData();
                            this.hideLoading();
                        }
                    };
                    script.onerror = () => {
                        console.warn(`âŒ ç„¡æ³•è¼‰å…¥ ${file.name} è³‡æ–™`);
                        loadedCount++;
                        // å»ºç«‹ç©ºçš„è³‡æ–™çµæ§‹
                        this.vocabularyData[file.name] = [];
                        if (loadedCount === totalFiles) {
                            this.ensureVocabularyData();
                            this.hideLoading();
                        }
                    };
                    document.head.appendChild(script);
                });
            },

            // éš±è—è¼‰å…¥ç•«é¢
            hideLoading: function() {
                document.getElementById('loadingText').style.display = 'none';
                document.getElementById('mainMenuButtons').style.display = 'block';
            },

            // åˆ†é…å–®å­—è³‡æ–™
           assignVocabularyData: function(fileName) {
    console.log(`ğŸ“¥ åˆ†é…è³‡æ–™: ${fileName}`);
    
    switch(fileName) {
        case 'nouns':
            this.vocabularyData.nouns = window.nounsData || [];
            console.log(`âœ… åè©è³‡æ–™åˆ†é…å®Œæˆ:`, this.vocabularyData.nouns.length);
            break;
        case 'i_adjectives':
            this.vocabularyData.i_adjective = window.iAdjectivesData || [];
            break;
        case 'na_adjectives':
            this.vocabularyData.na_adjective = window.naAdjectivesData || [];
            break;
        case 'verbs':
            this.vocabularyData.verb = window.verbsData || [];
            break;
        case 'adverbs':
            this.vocabularyData.adverb = window.adverbsData || [];
            break;
        case 'onomatopoeia':
            this.vocabularyData.onomatopoeia = window.onomatopoeiaData || [];
            break;
        case 'keigo':
            this.vocabularyData.keigo = window.keigoData || [];
            break;
        case 'grammar':
            this.vocabularyData.grammar = window.grammarData || [];
            break;
    }
},

            // ç¢ºä¿æœ‰å–®å­—è³‡æ–™
            ensureVocabularyData: function() {
                // æª¢æŸ¥æ¯å€‹é¡åˆ¥æ˜¯å¦æœ‰è³‡æ–™ï¼Œå¦‚æœæ²’æœ‰å°±å»ºç«‹ç©ºé™£åˆ—
                const categories = ['nouns', 'i_adjective', 'na_adjective', 'verb', 'adverb', 'onomatopoeia', 'keigo', 'grammar'];
                categories.forEach(cat => {
                    if (!this.vocabularyData[cat]) {
                        this.vocabularyData[cat] = [];
                    }
                });
                
                // é¡¯ç¤ºè¼‰å…¥çš„å–®å­—æ•¸é‡
                let totalWords = 0;
                categories.forEach(cat => {
                    totalWords += this.vocabularyData[cat].length;
                });
                console.log(`ğŸ“Š ç¸½å…±è¼‰å…¥ ${totalWords} å€‹å–®å­—`);
            },

            // é¡¯ç¤ºç•«é¢
            showScreen: function(screenId) {
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.remove('active');
                });
                document.getElementById(screenId).classList.add('active');
                
                if (screenId === 'progressScreen') {
                    this.showProgressStats();
                } else if (screenId === 'favoriteScreen') {
                    this.showFavoriteList();
                }
            },

            // åˆ‡æ›è‡ªå®šç¾©ç¯„åœé¡¯ç¤º
            toggleCustomRange: function() {
                const type = document.getElementById('quizType').value;
                document.getElementById('customRangeGroup').style.display = 
                    type === 'custom' ? 'block' : 'none';
            },

            toggleStudyCustomRange: function() {
                const type = document.getElementById('studyType').value;
                document.getElementById('studyCustomRangeGroup').style.display = 
                    type === 'custom' ? 'block' : 'none';
            },

            // é–‹å§‹æ¸¬é©—
            startQuiz: function() {
                const type = document.getElementById('quizType').value;
                const range = document.getElementById('customRange').value;
                const count = parseInt(document.getElementById('questionCount').value);
                
                this.currentQuizType = type;
                this.currentVocab = this.loadVocabulary(type, range);
                
                if (this.currentVocab.length === 0) {
                    alert('æ²’æœ‰æ‰¾åˆ°ç¬¦åˆçš„å–®å­—ï¼');
                    return;
                }
                
                // éš¨æ©Ÿé¸æ“‡æŒ‡å®šæ•¸é‡çš„å–®å­—
                this.currentVocab = this.shuffleArray(this.currentVocab).slice(0, count);
                this.currentQuestionIndex = 0;
                this.score = 0;
                this.quizMode = true;
                
                this.showScreen('quizScreen');
                this.showQuestion();
            },

            // é–‹å§‹èƒŒèª¦
            startStudy: function() {
                const type = document.getElementById('studyType').value;
                const range = document.getElementById('studyCustomRange').value;
                
                this.currentQuizType = type;
                this.studyWords = this.loadVocabulary(type, range);
                
                if (this.studyWords.length === 0) {
                    alert('æ²’æœ‰æ‰¾åˆ°ç¬¦åˆçš„å–®å­—ï¼');
                    return;
                }
                
                this.currentStudyIndex = 0;
                this.quizMode = false;
                
                this.showScreen('studyScreen');
                this.showStudyWord();
            },

            // è¼‰å…¥å–®å­—è³‡æ–™
            loadVocabulary: function(type, range) {
                let words = [];

console.log(`ğŸ” è¼‰å…¥å–®å­—é¡å‹: ${type}`);
    console.log(`ğŸ“Š å¯ç”¨è³‡æ–™é¡åˆ¥:`, Object.keys(this.vocabularyData));
                
                if (type === 'mixed') {
                    // ç¶œåˆæ¨¡å¼ï¼šåˆä½µæ‰€æœ‰é¡åˆ¥
                    words = [
                        ...(this.vocabularyData.nouns || []),
                        ...(this.vocabularyData.i_adjective || []),
                        ...(this.vocabularyData.na_adjective || []),
                        ...(this.vocabularyData.verb || []),
                        ...(this.vocabularyData.adverb || []),
                        ...(this.vocabularyData.onomatopoeia || []),
                        ...(this.vocabularyData.keigo || []),
                        ...(this.vocabularyData.grammar || [])
                    ];
		    console.log(`ğŸ¯ ç¶œåˆæ¨¡å¼è¼‰å…¥ ${words.length} å€‹å–®å­—`);
                 } else if (type === 'custom') {
        words = this.loadCustomRange(range);
    } else if (type === 'favorite') {
        words = this.getFavorites();
    } else {
        // å–®ä¸€é¡åˆ¥æ¨¡å¼
        console.log(`ğŸ” å˜—è©¦è¼‰å…¥é¡åˆ¥ ${type}:`, this.vocabularyData[type]);
        words = this.vocabularyData[type] || [];
        console.log(`ğŸ“ ${type} é¡åˆ¥è¼‰å…¥ ${words.length} å€‹å–®å­—`);
    }
    
    return words;
            },

            // è¼‰å…¥è‡ªå®šç¾©ç¯„åœ
            loadCustomRange: function(range) {
                const allWords = [
                    ...(this.vocabularyData.nouns || []),
                    ...(this.vocabularyData.i_adjective || []),
                    ...(this.vocabularyData.na_adjective || []),
                    ...(this.vocabularyData.verb || []),
                    ...(this.vocabularyData.adverb || []),
                    ...(this.vocabularyData.onomatopoeia || []),
                    ...(this.vocabularyData.keigo || []),
                    ...(this.vocabularyData.grammar || [])
                ];
                
                if (range) {
                    const [start, end] = range.split('-');
                    return allWords.filter(word => {
                        return word.id >= start && word.id <= end;
                    });
                }
                
                return allWords;
            },

            // é¡¯ç¤ºæ¸¬é©—é¡Œç›®
            showQuestion: function() {
                const current = this.currentVocab[this.currentQuestionIndex];
                document.getElementById('questionText').textContent = current.hiragana;
                document.getElementById('progressText').textContent = 
                    `${this.currentQuestionIndex + 1}/${this.currentVocab.length}`;
                document.getElementById('answerDisplay').style.display = 'none';
                document.getElementById('showAnswerBtn').style.display = 'block';
                document.getElementById('nextBtn').style.display = 'none';
                
                // é¡¯ç¤ºæ¸¬é©—é¡åˆ¥
                const categoryNames = {
    'mixed': 'ç¶œåˆ',
    'nouns': 'åè©',           // æ”¹ç‚º nouns
    'i_adjective': 'ã„å½¢å®¹è©',
    'na_adjective': 'ãªå½¢å®¹è©', 
    'verb': 'å‹•è©',            // æ”¹ç‚º verb
    'adverb': 'å‰¯è©',          // æ”¹ç‚º adverb
    'onomatopoeia': 'ç–Šè©',
    'keigo': 'æ•¬èª',
    'grammar': 'æ–‡æ³•',
    'favorite': 'æ”¶è—'
};
                document.getElementById('quizCategory').textContent = categoryNames[this.currentQuizType];
                
                // æ›´æ–°æ”¶è—æŒ‰éˆ•ç‹€æ…‹
                this.updateFavoriteButton('quizFavoriteBtn', current);
                
                // ç”Ÿæˆé¸é …
                const options = this.generateOptions(current);
                const optionsContainer = document.getElementById('optionsContainer');
                optionsContainer.innerHTML = '';
                
                options.forEach(option => {
                    const button = document.createElement('button');
                    button.className = 'option-btn';
                    button.textContent = option;
                    button.setAttribute('data-action', 'checkAnswer');
                    button.onclick = () => this.checkAnswer(option, current);
                    optionsContainer.appendChild(button);
                });
            },

            // é¡¯ç¤ºèƒŒèª¦å–®å­—
            showStudyWord: function() {
                const current = this.studyWords[this.currentStudyIndex];
                document.getElementById('studyQuestionText').textContent = current.hiragana;
                document.getElementById('studyProgressText').textContent = 
                    `${this.currentStudyIndex + 1}/${this.studyWords.length}`;
                document.getElementById('studyAnswerDisplay').style.display = 'none';
                
                // é¡¯ç¤ºèƒŒèª¦é¡åˆ¥
                const categoryNames = {
                    'mixed': 'ç¶œåˆ',
                    'noun': 'åè©',
                    'i_adjective': 'ã„å½¢å®¹è©',
                    'na_adjective': 'ãªå½¢å®¹è©',
                    'verb': 'å‹•è©',
                    'adverb': 'å‰¯è©',
                    'onomatopoeia': 'ç–Šè©',
                    'keigo': 'æ•¬èª',
                    'grammar': 'æ–‡æ³•',
                    'favorite': 'æ”¶è—'
                };
                document.getElementById('studyCategory').textContent = categoryNames[this.currentQuizType];
                
                // æ›´æ–°æ”¶è—æŒ‰éˆ•ç‹€æ…‹
                this.updateFavoriteButton('studyFavoriteBtn', current);
            },

            // æ›´æ–°æ”¶è—æŒ‰éˆ•ç‹€æ…‹
            updateFavoriteButton: function(buttonId, word) {
                const button = document.getElementById(buttonId);
                const isFavorite = this.isFavorite(word);
                button.textContent = isFavorite ? 'â˜…' : 'â˜†';
                button.style.color = isFavorite ? '#e53e3e' : '#718096';
            },

            // ç”Ÿæˆé¸é …
            generateOptions: function(correctWord) {
                const options = [correctWord.meaning];
                const otherWords = this.currentVocab.filter(word => word.id !== correctWord.id);
                const shuffledOthers = this.shuffleArray(otherWords);
                
                // åŠ å…¥3å€‹éŒ¯èª¤é¸é …
                for (let i = 0; i < 3 && i < shuffledOthers.length; i++) {
                    options.push(shuffledOthers[i].meaning);
                }
                
                return this.shuffleArray(options);
            },

            // æª¢æŸ¥ç­”æ¡ˆ
            checkAnswer: function(selected, correct) {
                const isCorrect = selected === correct.meaning;
                if (isCorrect) this.score++;
                
                this.showAnswer();
                
                // ç¦ç”¨æ‰€æœ‰é¸é …æŒ‰éˆ•
                document.querySelectorAll('.option-btn').forEach(btn => {
                    btn.disabled = true;
                    if (btn.textContent === correct.meaning) {
                        btn.classList.add('correct');
                    } else if (btn.textContent === selected && !isCorrect) {
                        btn.classList.add('incorrect');
                    }
                });
                
                document.getElementById('showAnswerBtn').style.display = 'none';
                document.getElementById('nextBtn').style.display = 'block';
            },

            // é¡¯ç¤ºè§£ç­”
            showAnswer: function() {
                const current = this.currentVocab[this.currentQuestionIndex];
                const answerDiv = document.getElementById('answerDisplay');
                answerDiv.innerHTML = `
                    <div style="margin-bottom: 8px;">
                        <strong style="font-size: 1.2em;">${current.kanji || current.hiragana}</strong>
                        <span style="color: #718096; font-size: 0.9em; margin-left: 8px;">${current.id}</span>
                    </div>
                    <div style="margin-bottom: 8px;"><strong>ä¸­æ–‡:</strong> ${current.meaning}</div>
                    <div style="margin-bottom: 8px;"><strong>ç”¨æ³•:</strong> ${current.usage}</div>
                    <div style="color: #4a5568; font-size: 0.9em;"><em>${current.particle_explanation}</em></div>
                `;
                answerDiv.style.display = 'block';
            },

            // é¡¯ç¤ºèƒŒèª¦è§£ç­”
            showStudyAnswer: function() {
                const current = this.studyWords[this.currentStudyIndex];
                const answerDiv = document.getElementById('studyAnswerDisplay');
                answerDiv.innerHTML = `
                    <div style="margin-bottom: 8px;">
                        <strong style="font-size: 1.2em;">${current.kanji || current.hiragana}</strong>
                        <span style="color: #718096; font-size: 0.9em; margin-left: 8px;">${current.id}</span>
                    </div>
                    <div style="margin-bottom: 8px;"><strong>ä¸­æ–‡:</strong> ${current.meaning}</div>
                    <div style="margin-bottom: 8px;"><strong>ç”¨æ³•:</strong> ${current.usage}</div>
                    <div style="color: #4a5568; font-size: 0.9em;"><em>${current.particle_explanation}</em></div>
                `;
                answerDiv.style.display = 'block';
            },

            // ä¸‹ä¸€é¡Œ
            nextQuestion: function() {
                this.currentQuestionIndex++;
                if (this.currentQuestionIndex < this.currentVocab.length) {
                    this.showQuestion();
                } else {
                    this.endQuiz();
                }
            },

            // ä¸‹ä¸€å€‹èƒŒèª¦å–®å­—
            nextStudyWord: function() {
                this.currentStudyIndex++;
                if (this.currentStudyIndex < this.studyWords.length) {
                    this.showStudyWord();
                } else {
                    alert('ğŸ‰ èƒŒèª¦å®Œæˆï¼');
                    this.showScreen('mainMenu');
                }
            },

            // çµæŸæ¸¬é©—
            endQuiz: function() {
                const percentage = Math.round((this.score / this.currentVocab.length) * 100);
                let message = `ğŸ‰ æ¸¬é©—å®Œæˆï¼\nå¾—åˆ†: ${this.score}/${this.currentVocab.length} (${percentage}%)`;
                
                if (percentage >= 90) {
                    message += '\n\nğŸ† å„ªç§€ï¼è¡¨ç¾å¾ˆæ£’ï¼';
                } else if (percentage >= 70) {
                    message += '\n\nğŸ‘ ä¸éŒ¯ï¼ç¹¼çºŒåŠ æ²¹ï¼';
                } else {
                    message += '\n\nğŸ’ª ç¹¼çºŒåŠªåŠ›ï¼Œä¸‹æ¬¡æœƒæ›´å¥½ï¼';
                }
                
                alert(message);
                this.saveProgress(this.score, this.currentVocab.length);
                this.showScreen('mainMenu');
            },

            // æå‰çµæŸæ¸¬é©—
            endQuizEarly: function() {
                if (confirm('ç¢ºå®šè¦æå‰çµæŸæ¸¬é©—å—ï¼Ÿ')) {
                    const answeredQuestions = this.currentQuestionIndex + 1;
                    const percentage = answeredQuestions > 0 ? Math.round((this.score / answeredQuestions) * 100) : 0;
                    alert(`â¹ï¸ æ¸¬é©—æå‰çµæŸï¼\nå¾—åˆ†: ${this.score}/${answeredQuestions} (${percentage}%)`);
                    this.showScreen('mainMenu');
                }
            },

            // æå‰çµæŸèƒŒèª¦
            endStudyEarly: function() {
                if (confirm('ç¢ºå®šè¦æå‰çµæŸèƒŒèª¦å—ï¼Ÿ')) {
                    this.showScreen('mainMenu');
                }
            },

            // æ”¶è—åŠŸèƒ½
            toggleFavorite: function() {
                const current = this.currentVocab[this.currentQuestionIndex];
                this.toggleFavoriteWord(current);
                this.updateFavoriteButton('quizFavoriteBtn', current);
            },

            toggleStudyFavorite: function() {
                const current = this.studyWords[this.currentStudyIndex];
                this.toggleFavoriteWord(current);
                this.updateFavoriteButton('studyFavoriteBtn', current);
            },

            toggleFavoriteWord: function(word) {
                const favorites = this.getFavorites();
                const index = favorites.findIndex(fav => fav.id === word.id);
                
                if (index === -1) {
                    // åŠ å…¥æ”¶è—
                    favorites.push(word);
                } else {
                    // ç§»é™¤æ”¶è—
                    favorites.splice(index, 1);
                }
                
                this.saveFavorites(favorites);
            },

            isFavorite: function(word) {
                const favorites = this.getFavorites();
                return favorites.some(fav => fav.id === word.id);
            },

            getFavorites: function() {
                return JSON.parse(localStorage.getItem('vocabFavorites') || '[]');
            },

            saveFavorites: function(favorites) {
                localStorage.setItem('vocabFavorites', JSON.stringify(favorites));
            },

            // å¾æ”¶è—é–‹å§‹æ¸¬é©—
            startQuizFromFavorites: function() {
                const favorites = this.getFavorites();
                if (favorites.length === 0) {
                    alert('é‚„æ²’æœ‰æ”¶è—ä»»ä½•å–®å­—ï¼');
                    return;
                }
                
                this.currentQuizType = 'favorite';
                this.currentVocab = favorites;
                this.currentQuestionIndex = 0;
                this.score = 0;
                this.quizMode = true;
                
                this.showScreen('quizScreen');
                this.showQuestion();
            },

            // å¾æ”¶è—é–‹å§‹èƒŒèª¦
            startStudyFromFavorites: function() {
                const favorites = this.getFavorites();
                if (favorites.length === 0) {
                    alert('é‚„æ²’æœ‰æ”¶è—ä»»ä½•å–®å­—ï¼');
                    return;
                }
                
                this.currentQuizType = 'favorite';
                this.studyWords = favorites;
                this.currentStudyIndex = 0;
                this.quizMode = false;
                
                this.showScreen('studyScreen');
                this.showStudyWord();
            },

            showFavoriteList: function() {
                const favorites = this.getFavorites();
                const listDiv = document.getElementById('favoriteList');
                
                if (favorites.length === 0) {
                    listDiv.innerHTML = '<div class="stats"><p>é‚„æ²’æœ‰æ”¶è—ä»»ä½•å–®å­—</p></div>';
                    return;
                }
                
                let html = '<div class="stats">';
                favorites.forEach(word => {
                    const categoryIcon = this.getCategoryIcon(word.id);
                    html += `
                        <div style="margin-bottom: 12px; padding: 12px; border-bottom: 1px solid #e2e8f0; border-radius: 8px; background: white;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="flex: 1;">
                                    <strong>${word.id}: ${word.kanji || word.hiragana}</strong>
                                    <span style="color: #718096; font-size: 0.9em;"> - ${word.meaning}</span>
                                </div>
                                <span style="font-size: 1.2em;">${categoryIcon}</span>
                            </div>
                            <div style="color: #718096; font-size: 0.85em; margin-top: 4px;">${word.usage}</div>
                        </div>
                    `;
                });
                html += '</div>';
                listDiv.innerHTML = html;
            },

            // å–å¾—é¡åˆ¥åœ–æ¨™
            getCategoryIcon: function(wordId) {
                const prefix = wordId.charAt(0);
                const icons = {
                    'N': 'ğŸ“–', // åè©
                    'I': 'ğŸ”µ', // ã„å½¢å®¹è©
                    'A': 'ğŸŸ¢', // ãªå½¢å®¹è©
                    'V': 'ğŸƒ', // å‹•è©
                    'D': 'âš¡', // å‰¯è©
                    'O': 'ğŸ”Š', // ç–Šè©
                    'K': 'ğŸ™', // æ•¬èª
                    'G': 'ğŸ“'  // æ–‡æ³•
                };
                return icons[prefix] || 'ğŸ“';
            },

            // æ–‡å­—è½‰èªéŸ³
            speakText: function(text) {
                if ('speechSynthesis' in window) {
                    // åœæ­¢ä¹‹å‰çš„èªéŸ³
                    window.speechSynthesis.cancel();
                    
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'ja-JP';
                    utterance.rate = 0.8;
                    utterance.pitch = 1.0;
                    utterance.volume = 0.8;
                    window.speechSynthesis.speak(utterance);
                } else {
                    alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³åŠŸèƒ½');
                }
            },

            speakCurrentWord: function() {
                const current = this.currentVocab[this.currentQuestionIndex];
                this.speakText(current.hiragana);
            },

            speakCurrentStudyWord: function() {
                const current = this.studyWords[this.currentStudyIndex];
                this.speakText(current.hiragana);
            },

            // å·¥å…·å‡½æ•¸
            shuffleArray: function(array) {
                const newArray = [...array];
                for (let i = newArray.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
                }
                return newArray;
            },

            // å­¸ç¿’é€²åº¦åŠŸèƒ½
            saveProgress: function(score, total) {
                const progress = JSON.parse(localStorage.getItem('vocabProgress') || '{}');
                const today = new Date().toISOString().split('T')[0];
                
                if (!progress[today]) {
                    progress[today] = { correct: 0, total: 0, sessions: 0 };
                }
                
                progress[today].correct += score;
                progress[today].total += total;
                progress[today].sessions += 1;
                
                localStorage.setItem('vocabProgress', JSON.stringify(progress));
            },

            loadProgress: function() {
                return JSON.parse(localStorage.getItem('vocabProgress') || '{}');
            },

            showProgressStats: function() {
                const progress = this.loadProgress();
                const statsDiv = document.getElementById('progressStats');
                
                if (Object.keys(progress).length === 0) {
                    statsDiv.innerHTML = '<div class="stats"><p>å°šç„¡å­¸ç¿’è¨˜éŒ„</p></div>';
                    return;
                }
                
                let html = '';
                let totalCorrect = 0;
                let totalQuestions = 0;
                let totalSessions = 0;
                
                // ä¾æ—¥æœŸé¡¯ç¤ºé€²åº¦
                const dates = Object.keys(progress).sort().reverse().slice(0, 7); // åªé¡¯ç¤ºæœ€è¿‘7å¤©
                dates.forEach(date => {
                    const data = progress[date];
                    const percentage = Math.round((data.correct / data.total) * 100);
                    totalCorrect += data.correct;
                    totalQuestions += data.total;
                    totalSessions += data.sessions;
                    
                    html += `
                        <div class="stats">
                            <strong>${date}</strong><br>
                            ğŸ“Š ç­”å°: ${data.correct}/${data.total} (${percentage}%)<br>
                            ğŸ¯ ç·´ç¿’æ¬¡æ•¸: ${data.sessions}æ¬¡
                        </div>
                    `;
                });
                
                // ç¸½è¨ˆ
                const totalPercentage = totalQuestions > 0 ? Math.round((totalCorrect / totalQuestions) * 100) : 0;
                html = `
                    <div class="stats" style="background: #e6fffa; border-left: 4px solid #38a169;">
                        <strong>ğŸ“ˆ ç¸½è¨ˆçµ±è¨ˆ</strong><br>
                        âœ… ç¸½ç­”å°: ${totalCorrect}/${totalQuestions} (${totalPercentage}%)<br>
                        ğŸ¯ ç¸½ç·´ç¿’æ¬¡æ•¸: ${totalSessions}æ¬¡<br>
                        ğŸ“… æœ€è¿‘è¨˜éŒ„: ${dates.length}å¤©
                    </div>
                ` + html;
                
                statsDiv.innerHTML = html;
            }
        };

        // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
        document.addEventListener('DOMContentLoaded', function() {
            app.init();
        });
    </script>
</body>
</html>